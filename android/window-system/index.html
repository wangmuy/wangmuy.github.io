<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    
    <title>Android 窗口系统 源码分析 | wangmuy 的技术博客</title>
    
    
        <meta name="keywords" content="Android 窗口系统 源码分析">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="版本 android-4.3_r2.2涉及到的文件SystemServer进程应用进程">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 窗口系统 源码分析">
<meta property="og:url" content="http://yoursite.com/android/window-system/index.html">
<meta property="og:site_name" content="wangmuy 的技术博客">
<meta property="og:description" content="版本 android-4.3_r2.2涉及到的文件SystemServer进程应用进程">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-05-03T12:19:07.295Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 窗口系统 源码分析">
<meta name="twitter:description" content="版本 android-4.3_r2.2涉及到的文件SystemServer进程应用进程">
    

    
        <link rel="alternate" href="/atom.xml" title="wangmuy 的技术博客" type="application/atom+xml">
    

    
        <link rel="icon" href="/favicon.ico">
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">
    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
</head>
</html>
<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">wangmuy 的技术博客</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/">首页</a>
                
                    <a class="main-nav-link" href="/archives">归档</a>
                
                    <a class="main-nav-link" href="/categories">分类</a>
                
                    <a class="main-nav-link" href="/tags">标签</a>
                
                    <a class="main-nav-link" href="/about">关于</a>
                
            </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/">首页</a></td>
                
                    <td><a class="main-nav-link" href="/archives">归档</a></td>
                
                    <td><a class="main-nav-link" href="/categories">分类</a></td>
                
                    <td><a class="main-nav-link" href="/tags">标签</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索">
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap" id="categories">
        <h3 class="widget-title">
            <span>分类</span>
            &nbsp;
            <a id="allExpand" href="#">
                <i class="fa fa-angle-double-down fa-2x"></i>
            </a>
        </h3>
        
        
        
         <ul class="unstyled" id="tree"> 
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            android
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/android/input-system/">Android 输入系统 源码分析</a></li>  <li class="file active"><a href="/android/window-system/">Android 窗口系统 源码分析</a></li>  <li class="file"><a href="/android/startup-routines/">Android 启动流程 源码分析</a></li>  <li class="file"><a href="/android/recyclerview/">RecyclerView 源码分析</a></li>  <li class="file"><a href="/android/build-system/">Android 构建系统 源码分析</a></li>  <li class="file"><a href="/android/fresco/">Fresco 源码分析</a></li>  <li class="file"><a href="/android/aapt/">aapt 源码分析</a></li>  <li class="file"><a href="/android/debug-hwui-profile/">Android debug-hwui-profile</a></li>  <li class="file"><a href="/android/resolve-activity/">ResolverActivity 流程</a></li>  <li class="file"><a href="/android/package-installer-动态权限/">PackageInstaller 中的 动态权限</a></li>  <li class="file"><a href="/android/activity-透明非透明-转换/">Activity 透明/非透明 转换</a></li>  <li class="file"><a href="/android/systemui-recents/">SystemUI 最近应用 源码分析</a></li>  <li class="file"><a href="/android/repo-refs-m分析/">repo refs/remotes/m 来源分析</a></li>  <li class="file"><a href="/android/uiautomator-启动流程/">uiautomator 启动流程</a></li>  <li class="file"><a href="/android/alert-window-权限控制/">Alert Window 弹窗控制</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            libgdx
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/libgdx/skin-load/">LibGDX skin load 源码分析</a></li>  <li class="file"><a href="/libgdx/dynamic-freetype/">LibGDX 实现 动态中文/freetype 加载</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            misc
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/misc/duilib使用/">duilib使用小结</a></li>  <li class="file"><a href="/misc/plantuml基础/">PlantUML 基础</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            mldl
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/mldl/torch-windows-build/">Torch windows 编译</a></li>  <li class="file"><a href="/mldl/tensorflow-core_rnn_cell-源码分析/">tensorflow rnn embedding</a></li>  <li class="file"><a href="/mldl/keras-examples/">keras examples 总结</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            nodejs
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/nodejs/crypto模块使用/">Node.js Crypto模块 使用示例</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            博客搭建
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/博客搭建/octopress-setup/">用Octopress在GitHub上搭建博客</a></li>  </ul> 
                    </li> 
                     </ul> 
    </div>
    <script>
        $(document).ready(function() {
            var iconFolderOpenClass  = 'fa-folder-open';
            var iconFolderCloseClass = 'fa-folder';
            var iconAllExpandClass = 'fa-angle-double-down';
            var iconAllPackClass = 'fa-angle-double-up';
            // Handle directory-tree expansion:
            // 左键单独展开目录
            $(document).on('click', '#categories a[data-role="directory"]', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var subtree = $(this).siblings('ul');
                icon.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    if (typeof subtree != 'undefined') {
                        subtree.slideUp({ duration: 100 });
                    }
                    icon.addClass(iconFolderCloseClass);
                } else {
                    if (typeof subtree != 'undefined') {
                        subtree.slideDown({ duration: 100 });
                    }
                    icon.addClass(iconFolderOpenClass);
                }
            });
            // 右键展开下属所有目录
            $('#categories a[data-role="directory"]').bind("contextmenu", function(event){
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var listNode = $(this).siblings('ul');
                var subtrees = $.merge(listNode.find('li ul'), listNode);
                var icons = $.merge(listNode.find('.fa'), icon);
                icons.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if(expanded) {
                    subtrees.slideUp({ duration: 100 });
                    icons.addClass(iconFolderCloseClass);
                } else {
                    subtrees.slideDown({ duration: 100 });
                    icons.addClass(iconFolderOpenClass);
                }
            })
            // 展开关闭所有目录按钮
            $(document).on('click', '#allExpand', function (event) {
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconAllExpandClass);
                icon.removeClass(iconAllExpandClass).removeClass(iconAllPackClass);
                if(expanded) {
                    $('#sidebar .fa.fa-folder').removeClass('fa-folder').addClass('fa-folder-open')
                    $('#categories li ul').slideDown({ duration: 100 });
                    icon.addClass(iconAllPackClass);
                } else {
                    $('#sidebar .fa.fa-folder-open').removeClass('fa-folder-open').addClass('fa-folder')
                    $('#categories li ul').slideUp({ duration: 100 });
                    icon.addClass(iconAllExpandClass);
                }
            });  
        });
    </script>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
            <section id="main"><article id="post-android/window-system" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/android/">android</a>
    </div>

                        
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/android/window-system/">
            <time datetime="2013-11-07T07:20:00.000Z" itemprop="datePublished">2013-11-07</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                            <div class="article-meta-button">
                                <a href="https://github.com/wangmuy/wangmuy.github.io/raw/hexo/source/_posts/android/window-system.md" rel="external nofollow noopener noreferrer" target="_blank"> Source </a>
                            </div>
                            <div class="article-meta-button">
                                <a href="https://github.com/wangmuy/wangmuy.github.io/edit/hexo/source/_posts/android/window-system.md" rel="external nofollow noopener noreferrer" target="_blank"> Edit </a>
                            </div>
                            <div class="article-meta-button">
                                <a href="https://github.com/wangmuy/wangmuy.github.io/commits/hexo/source/_posts/android/window-system.md" rel="external nofollow noopener noreferrer" target="_blank"> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 class="article-title" itemprop="name">
            Android 窗口系统 源码分析
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
        
        
            <h1 id="版本-android-4-3-r2-2"><a href="#版本-android-4-3-r2-2" class="headerlink" title="版本 android-4.3_r2.2"></a>版本 android-4.3_r2.2</h1><h1 id="涉及到的文件"><a href="#涉及到的文件" class="headerlink" title="涉及到的文件"></a>涉及到的文件</h1><h1 id="SystemServer进程"><a href="#SystemServer进程" class="headerlink" title="SystemServer进程"></a>SystemServer进程</h1><h1 id="应用进程"><a href="#应用进程" class="headerlink" title="应用进程"></a>应用进程</h1><a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">承接 anatomy-of-android-startup-routines:</span><br><span class="line">ActivityThread#handleLaunchActivity(r, null) &#123; performLaunchActivity(); handleResumeActivity(); &#125;</span><br><span class="line"></span><br><span class="line">-&gt; ActivityThread#performLaunchActivity() &#123;</span><br><span class="line">   activity = newActivity();</span><br><span class="line">   Application app=makeApplication();</span><br><span class="line">   appContext = createBaseContextForActivity();</span><br><span class="line">   activity.attach(appContext, this, ..., app, ...);</span><br><span class="line">   mInstrumentation.callActivityOnCreate(activity, r.state); // activity.performCreate() -&gt; activity.onCreate();</span><br><span class="line">   if(!r.activity.mFinished):</span><br><span class="line">     activity.performStart();</span><br><span class="line">   if(!r.activity.mFinished &amp;&amp; r.state!=null):</span><br><span class="line">     mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</span><br><span class="line">   if(!r.activity.mFinished):</span><br><span class="line">     mInstrumentation.callActivityOnPostCreate(activity, r.state); &#125;</span><br><span class="line"></span><br><span class="line">  -&gt; Instrumentation#newActivity() &#123; ClassLoader.loadClass(className).newInstance(); &#125;</span><br><span class="line">  -&gt; LoadedApk#makeApplication() &#123; // 创建Application类的Context</span><br><span class="line">       ContextImpl appContext=new ContextImpl(); appContext.init(this, null, mActivityThread);</span><br><span class="line">       (Application app)=mActivityThread.mInstrumentation.newApplication(cl, appClass, appContext);</span><br><span class="line">       appContext.setOuterContext(app);</span><br><span class="line">       instrumentation.callApplicationOnCreate(app);</span><br><span class="line">     &#125;</span><br><span class="line">    -&gt; ContextImpl#类装载时 static &#123; registerService(WINDOW_SERVICE 等各种service); &#125;</span><br><span class="line">  -&gt; ActivityThread#createBaseContextForActivity(r, activity) &#123;</span><br><span class="line">       ContextImpl appContext = new ContextImpl();</span><br><span class="line">       appContext.init(r.packageInfo, r.token, this);</span><br><span class="line">       appContext.setOuterContext(activity;);</span><br><span class="line">       baseContext=appContext;</span><br><span class="line">       if(没有&quot;debug.second-display.pkg&quot;属性) return baseContext;</span><br><span class="line">     &#125;</span><br><span class="line">  -&gt; Activity#attach() -&gt; Activity#attach(context==ContextImpl appContext, ...) &#123;</span><br><span class="line">       attachBaseContext(context); // mBase==appContext</span><br><span class="line">       mFragments.attachActivity(this, mContainer, null);</span><br><span class="line">       (Window mWindow) = PolicyManager.makeNewWindow(this); // 得到 Window 子类 PhoneWindow</span><br><span class="line">       mWindow.setCallback(this);</span><br><span class="line">       mUiThread = Thread.currentThread();</span><br><span class="line">       mMainThread = 参数 ActivityThread aThread;</span><br><span class="line">       mWindow.setWindowManager(getSystemService(WINDOW_SERVICE));</span><br><span class="line">       mWindowManager = mWindow.getWindowManager(); // 取到WindowManagerImpl</span><br><span class="line">     &#125;</span><br><span class="line">    -&gt; PolicyManager#makeNewWindow() &#123; (com.android.internal.policy.impl.Policy sPolicy).makeNewWindow(); &#125;</span><br><span class="line">      -&gt; Policy#makeNewWindow() &#123;</span><br><span class="line">           return new PhoneWindow(context); &#125; // extends Window. mWindowAttributes = new WindowManager.LayoutParams();</span><br><span class="line">    -&gt; (Window PhoneWindow父类)#setWindowManager(wm, appToken, appName, hardwareAccelerated) &#123;</span><br><span class="line">    	wm!=null:</span><br><span class="line">    	  mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(this);</span><br><span class="line">    	  // PhoneWindow 作为本进程所有Window的parent &#125;</span><br><span class="line">      -&gt; WindowManagerImpl#createLocalWindowManager(parentWindow) &#123; return new WindowManagerImpl(mDisplay, parentWindow); &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">ActivityThread#handleResumeActivity(r.token, clearHide==false, r.isForward==false,</span><br><span class="line">  reallyResume = (!r.activity.mFinished &amp;&amp; !r.startsNotResumed) == true) &#123;</span><br><span class="line">  ActivityClientRecord r = performResumeActivity(token, clearHide==false);</span><br><span class="line">  Activity a = r.activity;</span><br><span class="line">  r.window==null &amp;&amp; !a.mFinished &amp;&amp; willBeVisible:</span><br><span class="line">    r.window = r.activity.getWindow(); // 就是 PhoneWindow</span><br><span class="line">    decor = r.window.getDecorView();</span><br><span class="line">    decor.setVisibility(INVISIBLE);</span><br><span class="line">    a.mDecor = decor;</span><br><span class="line">    if(a.mVisibleFromClient==初始化为true):</span><br><span class="line">      a.mWindowAdded=true;</span><br><span class="line">      WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">      l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line">      l.softInputMode |= (forwardBit==0);</span><br><span class="line">      (WindowManagerImpl wm).addView(decor, l);</span><br><span class="line">    if(!r.activity.mFinished &amp;&amp; willBeVisible &amp;&amp; r.activity.mDecor!=null &amp;&amp; !r.hideForNow):</span><br><span class="line">      r.activity.mVisibleFromServer = true;</span><br><span class="line">      if(r.activity.mVisibleFromClient) r.activity.makeVisible();</span><br><span class="line">    if(!r.onlyLocalRequest) Looper.myQueue().addIdleHandler(new Idler());</span><br><span class="line">    if(reallyResume) ActivityManagerNative.getDefault().activityResumed(token);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  -&gt; performResumeActivity() &#123; if!(r.activity.mFinished) r.activity.performResume(); &#125;</span><br><span class="line">    -&gt; Activity#performResume() &#123;</span><br><span class="line">    	performRestart(); // mStopped==false: pass</span><br><span class="line">    	mInstrumentation.callActivityOnResume(this); // activity.mResumed=true; activity.onResume()</span><br><span class="line">    	mFragments.dispatchResume();</span><br><span class="line">    	onPostResume(); &#125;</span><br><span class="line"></span><br><span class="line">  -&gt; PhoneWindow#getDecorView() &#123; if(mDecor==null) installDecor(); return mDecor; &#125;</span><br><span class="line">    -&gt; installDecor() &#123; if(mDecor==null) mDecor=generateDecor(); &#125;</span><br><span class="line">      -&gt; generateDecor() &#123; return new DecorView(getContext(), featureId==-1); &#125;</span><br><span class="line">         // PhoneWindow.DecorView extends FrameLayout implements RootViewSurfaceTaker</span><br><span class="line"></span><br><span class="line">  -&gt; WindowManagerImpl#addView()</span><br><span class="line">  -&gt; (单实例WindowManagerGlobal mglobal)#addView(view==DecorView decor, params, display, parentWindow==PhoneWindow) &#123;</span><br><span class="line">       root = new ViewRootImpl(view.getContext(), display);</span><br><span class="line">       view 加到 mViews[], root 加到 mRoots[].</span><br><span class="line">       (ViewRootImpl root).setView(view, wparams==params, panelParentView 非SUB_WINDOW类==NULL);</span><br><span class="line">     &#125;</span><br><span class="line">    -&gt; ViewRootImpl#ctor() &#123;</span><br><span class="line">    	mSurface = new Surface(); // 空surface, 以后通过 readFromParcel() 填充</span><br><span class="line">    	mWindowSession = WindowManagerGlobal.getWindowSession();</span><br><span class="line">    	mThread = Thread.currentThread();</span><br><span class="line">      mWindow = new W(this); // W extends IWindow.Stub</span><br><span class="line">      mAttachInfo = new View.AttachInfo(mWindowSession, mWindow, display, this, mHandler, this);</span><br><span class="line">    	mChoreographer = Chogreographer.getInstance();</span><br><span class="line">    	loadSystemProperties(); &#125;</span><br><span class="line">      -&gt; WindowManagerGlobal#getWindowSession() &#123;</span><br><span class="line">      	   if(sWindowSession==null):</span><br><span class="line">      	     windowManager = getWindowManagerService() &#123;</span><br><span class="line">      	     	sWindowManagerService = BinderProxy端 ServiceManager.getService(&quot;window&quot;); &#125;</span><br><span class="line">      	     sWindowSession = windowManager.openSession(</span><br><span class="line">      	     	(单实例InuptMethodManager imm).getClient(), imm.getInputContext() );</span><br><span class="line">      	     // BinderProxy端 IWindowSession, systemServer进程的WMS线程增加一个 Session.</span><br><span class="line">      	     return sWindowSession;</span><br><span class="line">         &#125;</span><br><span class="line">         --systemServer进程的WMS所在线程--&gt; WMS#openSession() &#123; new Session(service==WMS, ...); &#125;</span><br><span class="line">           -&gt; Session#ctor() &#123; mService.mInputMethodManager.addClient(</span><br><span class="line">           	InputMethodClient client, inputContext, mUid==应用的Uid, mPid==应用的Pid); &#125;</span><br><span class="line">    -&gt; ViewRootImpl#setView(view==DecorView decor, attrs=wparams, panelParentView==NULL) &#123;</span><br><span class="line">         mView == null:</span><br><span class="line">           mView = decor;</span><br><span class="line">           view instanceof RootViewSurfaceTaker:</span><br><span class="line">             mSurfaceHolderCallback = ((RootViewSurfaceTaker)view).willYouTakeTheSurface(); // == null</span><br><span class="line">           mSurfaceHolder == null: enableHardwareAcceleration(decor.getContext(), attrs);</span><br><span class="line">           mAdded = true;</span><br><span class="line">           requestLayout();</span><br><span class="line">           mWindowAttributes.inputFeatures==0: mInputChannel = new InputChannel();</span><br><span class="line">           (Session mWindowSession).addToDisplay(mWindow, mSeq==0, mWindowAttributes==attrs,</span><br><span class="line">             getHostVisibility(), mDisplay.getDisplayId(), mAttachInfo.mContentInsets, mInputChannel);</span><br><span class="line">       &#125;</span><br><span class="line">      -&gt; (PhoneWindow.DecorView implements RootViewSurfaceTaker)#willYouTakeTheSurface() &#123;</span><br><span class="line">           mFeatureId==-1 &lt; 0: return PhoneWindow.mTakeSurfaceCallback;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      -&gt; ViewRootImpl#enableHardwareAcceleration() &#123;</span><br><span class="line">          // HardwareRenderer.isAvailable() == true</span><br><span class="line">          mAttachInfo.mHardwareRenderer = HardwareRenderer.createGlRenderer(2, translucent);</span><br><span class="line">          mAttachInfo.mHardwareAccelerated = mAttachInfo.mHardwareAccelerationRequested = true;</span><br><span class="line">        &#125;</span><br><span class="line">        -&gt; HardwareRenderer#createGlRenderer()</span><br><span class="line">        -&gt; Gl20Renderer#create(translucent) &#123; if(GLES20Canvas.isAvailable(): new Gl20Renderer(translucent); &#125;</span><br><span class="line"></span><br><span class="line">      -&gt; Session#addToDisplay()</span><br><span class="line">        --Binder通信--&gt; WindowManagerService#addWindow(session, client==W, seq==0, attrs,</span><br><span class="line">            viewVisibility, displayId, outContentInsets, outInputChannel) &#123;</span><br><span class="line">            type == TYPE_BASE_APPLICATION;</span><br><span class="line">            (WindowToken token) 在 ActivityStack#startActivityLocked() -&gt; WMS#addAppToken() 中设置, 不为空.</span><br><span class="line">            (AppWindowToken atoken) 同上, 不为空.</span><br><span class="line">            win = new WindowState(this, session, client, token, attachedWindow, appOp[0],</span><br><span class="line">              seq, attrs, viewVisibility, displayContent);</span><br><span class="line">            (WindowManagerPolicy mPolicy 就是 PhoneWindowManager).adjustWindowParamsLw(win.mAttrs);</span><br><span class="line">            mPolicy.prepareAddWindowLw(win, attrs);</span><br><span class="line">            outInputChannel != null:</span><br><span class="line">              InputChannel.openInputChannelPair(name);</span><br><span class="line">              win.setInputChannel(inputChannels[0]);</span><br><span class="line">              inputChannels[1].transferTo(outInputChannel);</span><br><span class="line">              mInputManager.registerInputChannel(win.mInputChannel, win.minputWindowHandle);</span><br><span class="line">            win.attach();</span><br><span class="line">            mWindowMap.put(client.asBinder(), win);</span><br><span class="line">            type == TYPE_BASE_APPLICATION:</span><br><span class="line">              addWindowToListInOrderLocked(win, true);</span><br><span class="line">            win.mWinAnimator.mEnterAnimationPending = true;</span><br><span class="line">            if(displayContent.isDefaultDisplay) mPolicy.getContentInsetHintLw(attrs, outContentInsets);</span><br><span class="line">            mInputMonitor.setUpdateInputWindowsNeededLw();</span><br><span class="line">            if(win.canReceiveKeys()) focusChanged = updateFocusedWindowLocked();</span><br><span class="line">            assignLayersLocked(displayContent.getWindowList());</span><br><span class="line">          &#125;</span><br><span class="line">            -&gt; WindowState#ctor(service, Session s, IWindow c, WindowToken token, WindowState attachedWindow, int appOp, int seq, WindowManager.LayoutParams a, int viewVisibility, final DisplayContent displayContent) &#123;</span><br><span class="line">              mSession = s;</span><br><span class="line">              mWindowId = new IWindowId.Stub() &#123;&#125;</span><br><span class="line">              (IWindow c).asBinder().linkToDeath(new DeathRecipient(), 0);</span><br><span class="line">              type == TYPE_BASE_APPLICATION:</span><br><span class="line">                mBaseLayer = mPolicy.windowTypeToLayerLw(a.type) * ... + ...;</span><br><span class="line">                mSubLayer = 0;</span><br><span class="line">              mWinAnimator = new WindowStateAnimator(this);</span><br><span class="line">              mWinAnimator.mAlpha = a.alpha;</span><br><span class="line">            &#125;</span><br><span class="line">            -&gt; WindowState#attach() &#123; mSession.windowAddedLocked(); &#125;</span><br><span class="line">              -&gt; Session#windowAddedLocked() &#123;</span><br><span class="line">                mSurfaceSession = new SurfaceSession();</span><br><span class="line">                (WMS mService).mSessions.add(this);</span><br><span class="line">                mNumWindow++;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">  -&gt; Activity#makeVisible() &#123;</span><br><span class="line">    mWindowAdded == true: pass</span><br><span class="line">    mDecor.setVisibility(View.VISIBLE);</span><br><span class="line">  &#125;</span><br><span class="line">    -&gt; PhoneWindow.DecorView#setVisibility(View.VISIBLE) -&gt; (父类View#)setVisibility(View.VISIBLE)</span><br><span class="line">    -&gt; (父类View#)setFlags(flags==View.VISIBLE, mask==VISIBILITY_MASK) &#123;</span><br><span class="line">        (changed &amp; VISIBILITY_MASK) != 0:</span><br><span class="line">          mPrivateFlags |= PFLAG_DRAWN;</span><br><span class="line">          invalidate(true);</span><br><span class="line">          needGlobalAttributesUpdate(true);</span><br><span class="line">      &#125;</span><br><span class="line">    -&gt; (父类View#)invalidate(true) &#123;</span><br><span class="line">      HardwareRenderer.RENDER_DIRTY_REGIONS == true:</span><br><span class="line">        (p==mParent 这里是 ViewRootImpl).invalidateChild(this, r);</span><br><span class="line">    &#125;</span><br><span class="line">      -&gt; ViewRootImpl#invalidateChild(child==PhoneWindow.DecorView, dirty==r)</span><br><span class="line">      -&gt; ViewRootImpl#invalidateChildInParent(null, dirty==r) &#123; mWillDrawSoon 初始化为false: scheduleTraversals(); &#125;</span><br><span class="line">      -&gt; ViewRootImpl#scheduleTraversals() &#123;</span><br><span class="line">        mTraversalScheduled = true;</span><br><span class="line">        mChoreographer.postCallback(Choreographer.CALLBACK_TRAVERSAL,</span><br><span class="line">          mTraversalRunnable, null);// ViewRootImpl#doTraversal()</span><br><span class="line">        scheduleConsumeBatchedInput();</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><span class="line">ViewRootImpl#mChoreographer 是 ThreadLocal 的, 依附在 ViewRootImpl 所在的 Looper 上.</span><br><span class="line">USE_VSYNC 时用</span><br><span class="line">(FrameDisplayEventReceiver mDisplayEventReceiver).scheduleVsync() --VSYNC--&gt; onVsync()</span><br><span class="line">  --Choreographer#mHandler--&gt; doFrame() -&gt; 从 CALLBACK_INPUT, CALLBACK_ANIMATION, CALLBACK_TRAVERSAL 队列取回调执行.</span><br><span class="line"></span><br><span class="line">ViewRootImpl#doTraversal()</span><br><span class="line">  -&gt; ViewRootImpl#performTraversals() &#123;</span><br><span class="line">    mIsInTraversal = true;</span><br><span class="line">    mWillDrawSoon = true;</span><br><span class="line">    mFirst == ture:</span><br><span class="line">      mFullRedrawNeeded = true;</span><br><span class="line">      mLayoutRequested = true;</span><br><span class="line">      attachInfo.mSurface = mSurface;</span><br><span class="line">      (host==mView DecorView).dispatchAttachedToWindow(attachInfo, 0);</span><br><span class="line">      ...</span><br><span class="line">      host.fitSystemWindows();</span><br><span class="line">    mLayoutRequest == true &amp;&amp; !mStopped:</span><br><span class="line">      ensureTouchModeLocally();</span><br><span class="line">      measureHierarchy(host, lp, res, disiredWindowWidth, desiredWindowHeight);</span><br><span class="line">    hadSurface = mSurface.isValid(); // == false, 下面relayoutWindow填充</span><br><span class="line">    mFirst == true:</span><br><span class="line">      relayoutWindow(params, viewVisibility, insetsPending);</span><br><span class="line">    !mStopped:</span><br><span class="line">      performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">    didLayout:</span><br><span class="line">      performLayout(lp, desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">    mFirst == true:</span><br><span class="line">      mView.requestFocus(View.FOCUS_FORWARD);</span><br><span class="line">    !hadSurface &amp;&amp; mSurface.isValid(): &#123; newSurface = true; mFullRedrawNeeded = true; &#125;</span><br><span class="line">    // If we are creating a new surface, then we need to</span><br><span class="line">    // completely redraw it.  Also, when we get to the</span><br><span class="line">    // point of drawing it we will hold off and schedule</span><br><span class="line">    // a new traversal instead.</span><br><span class="line">    mWillDrawSoon = false;</span><br><span class="line">    ...</span><br><span class="line">    scheduleTraversals(); // 第二遍时会调 performDraw()</span><br><span class="line">    mIsInTraversal = false;</span><br><span class="line">  &#125;</span><br><span class="line">    -&gt; (DecorView 父类 ViewGroup)#dispatchAttachedToWindow(attachInfo, visibility==0) &#123;</span><br><span class="line">      for child: child.dispatchAttachedToWindow(info, ...); // (View child).mAttachInfo = info</span><br><span class="line">      // 动态添加的view也可以在 addView() -&gt; addViewInner() 时设置 mAttachInfo</span><br><span class="line">    &#125;</span><br><span class="line">    -&gt; (DecorView 父类 ViewGroup)#fitSystemWindows() &#123;</span><br><span class="line">      done = (super==View).fitSystemWindows(); // View#computeFitSystemWindows()</span><br><span class="line">      if(!done):</span><br><span class="line">        for child:</span><br><span class="line">          done = child.fitSystemWindows();</span><br><span class="line">    &#125;</span><br><span class="line">      -&gt; (DecorView 父类 View)#fitSystemWindows() -&gt; DecorView#internalSetPadding()</span><br><span class="line">        -&gt; View#internalSetPadding() &#123; if(changed): requestLayout(); &#125;</span><br><span class="line">    -&gt; ViewRootImpl#measureHierarchy() -&gt; ViewRootImpl#performMeasure() &#123; (DecorView mView).measure(); &#125;</span><br><span class="line">      -&gt; (DecorView 父类View)#measure() -&gt; DecorView#onMeasure() -&gt; MeasureSpec#makeMeasureSpec()</span><br><span class="line">      -&gt; (父类FrameLayout)#onMeasure() &#123;</span><br><span class="line">        for(getChildCount()) measureChildWithMargins(child, ...);</span><br><span class="line">        setMeasuredDimension(resolveSizeAndState(), ...);</span><br><span class="line">      &#125;</span><br><span class="line">      -&gt; (父类View)#measureChildWIthMargins() &#123; child.measure(); &#125;</span><br><span class="line">      --如果有child--&gt; (View或其子类)#measure() -&gt; (View或其子类)#onMeasure() -&gt; (View或其子类)#setMeasuredDimension()</span><br><span class="line"></span><br><span class="line">    -&gt; ViewRootImpl#relayoutWindow() &#123; (IWindowSession mWindowSession).relayout(); &#125;</span><br><span class="line">    --Binder通信--&gt; Session#relayout()</span><br><span class="line">    -&gt; WindowManagerService#relayoutWindow() &#123;</span><br><span class="line">      (WindowStateAnimator winAnimator).applyEnterAnimationLocked();</span><br><span class="line">      outSurface.copyFrom(winAnimator.createSurfaceLocked());</span><br><span class="line">      ...</span><br><span class="line">      performLayoutAndPlaceSurfacesLocked();</span><br><span class="line">    &#125;</span><br><span class="line">      -&gt; WindowStateAnimator#createSurfaceLocked() &#123;</span><br><span class="line">        (WMS mService).makeWindowFreezingScreenIfNeededLocked(mWin);</span><br><span class="line">        mSurfaceControl = new SurfaceControl(mSession.mSurfaceSession, attrs.getTitle(), w, h, format, flags);</span><br><span class="line">        SurfaceControl.openTransaction();</span><br><span class="line">        mSurfaceControl.setPosition(mSurfaceX, mSurfaceY);</span><br><span class="line">        mSurfaceLayer = mAnimLayer;</span><br><span class="line">        mSurfaceControl.setLayerStack(mLayerStack);</span><br><span class="line">        mSurfaceControl.setLayer(mAnimLayer);</span><br><span class="line">        mSurfaceControl.setAlpha(0);</span><br><span class="line">      &#125;</span><br><span class="line">      -&gt; WMS#performLayoutAndPlaceSurfacesLocked() &#123;</span><br><span class="line">          loopCount = 6;</span><br><span class="line">          do &#123;</span><br><span class="line">            mTraversalScheduled = false;</span><br><span class="line">            performLayoutAndPlaceSurfacesLockedLoop();</span><br><span class="line">            ...</span><br><span class="line">            loopCount--;</span><br><span class="line">            &#125; while(mTraversalScheduled &amp;&amp; loopCount &gt; 0);</span><br><span class="line">        &#125;</span><br><span class="line">        -&gt; WMS#performLayoutAndPlaceSurfacesLockedLoop() -&gt; WMS#performLayoutAndPlaceSurfacesLockedInner() &#123;</span><br><span class="line">            ...</span><br><span class="line">            performLayoutLockedInner(displayContent, repeats == 1, false);</span><br><span class="line">            ...</span><br><span class="line">            scheduleAnimationLocked();</span><br><span class="line">          &#125;</span><br><span class="line">          -&gt; WMS#performLayoutLockedInner() &#123;</span><br><span class="line">              (mPolicy 就是 PhoneWindowManager).beginLayoutLw(isDefaultDisplay, dw, dh, mRotation);</span><br><span class="line">              // 计算 mNavigationBar.computeFrameLw() 和 mStatusBar.computeFrameLw()</span><br><span class="line">              for WindowState win:</span><br><span class="line">                !gone &amp;&amp; !win.mLayoutAttached:</span><br><span class="line">                  win.preLayout();</span><br><span class="line">                  mPolicy.layoutWindowLw(win, win.mAttrs, null);</span><br><span class="line">            &#125;</span><br><span class="line">            -&gt; PhoneWindowManager#layoutWindowLw(WindowState win, win.mAttrs, attached==null) &#123;</span><br><span class="line">                win.computeFrameLw(pf, df, of, cf, vf);</span><br><span class="line">                // 设置 mContainingFrame, mDisplayFrame, mParentFrame, mOverScanFrame,</span><br><span class="line">                // mContentFrame, mVisibleFrame, mFrame, mOverscanInsets, mContentInsets, mVisibleInsets, mCompatFrame 等</span><br><span class="line">              &#125;</span><br><span class="line">          -&gt; WMS#scheduleAnimationLocked() &#123;</span><br><span class="line">              mAnimationScheduled = true;</span><br><span class="line">              mChoreographer.postCallback(CALLBACK_ANIMATION, mAnimator.mAnimationRunnable, null;)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    -&gt; ViewRootImpl#performDraw() &#123; draw(fullRedrawNeeded); 如果有mSurfaceHolder,调SurfaceHolder.Callback; &#125;</span><br><span class="line">    -&gt; ViewRootImpl#draw(fullRedrawNeeded) &#123;</span><br><span class="line">        sFirstDrawComplete 初始化为false: for() mHandler.post(sFirstDrawHandlers.get(i));</span><br><span class="line">        !dirty.isEmpty():</span><br><span class="line">          attachInfo.mHardwareRenderer.isEnabled() 初始化为false, attachInfo.mHardwareRenderer.isRequested() 初始化== true:</span><br><span class="line">            attachInfo.mHardwareRenderer.initializeIfNeeded();</span><br><span class="line">            mFullRedrawNeeded = true;</span><br><span class="line">            scheduleTraversals();</span><br><span class="line">            // 下一遍 performTraversals() -&gt; performDraw() -&gt; draw() 时 attachInfo.mHardwareRenderer.draw(),</span><br><span class="line">            // 就是 Gl20Renderer#draw()</span><br><span class="line">      &#125;</span><br><span class="line">      -&gt; (Gl20Renderer 父类HardwareRenderer)#initializeIfNeeded(width, height, surface) &#123;</span><br><span class="line">          isRequested() == true, !isEnabled() == true:</span><br><span class="line">            initialize(surface);</span><br><span class="line">            setup(width, height);</span><br><span class="line">        &#125;</span><br><span class="line">        -&gt; (Gl20Renderer 父类GlRenderer)#initialize(surface) &#123;</span><br><span class="line">            initializeEgl(); // sEgl = com.google.android.gles_jni.EGLImpl()</span><br><span class="line">            mGl = createEglSurface(surface);</span><br><span class="line">            mCanvas = createCanvas(); // GLES20Canvas</span><br><span class="line">            setEnabled(true);</span><br><span class="line">          &#125;</span><br><span class="line">          -&gt; Gl20Renderer#createCanvas() &#123; mGlCanvas = new GLES20Canvas(mTranslucent); &#125;</span><br><span class="line">          -&gt; GLES20Canvas#ctor(record==false, translucent) &#123;</span><br><span class="line">              mRenderer = nCreateRenderer(); // C++: new OpenGLRenderer()</span><br><span class="line">              setupFinalizer(); // new CanvasFinalizer(mRenderer)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">      -&gt; (Gl20Renderer 父类GlRenderer)#draw(view, attachInfo, callbacks, dirty) &#123;</span><br><span class="line">          dirty = beginFrame(canvas, dirty, surfaceState); // canvas == mCanvas</span><br><span class="line">          DisplayList displayList = buildDisplayList(view, mCanvas);</span><br><span class="line">          status = prepareFrame(dirty);</span><br><span class="line">          saveCount = canvas.save();</span><br><span class="line">          callbacks.onHardwarePreDraw(canvas);</span><br><span class="line">          displayList != null:</span><br><span class="line">            status |= drawDisplayList(attachInfo, canvas, displayList, status);</span><br><span class="line">          callbacks.onHardwarePostDraw(canvas);</span><br><span class="line">          canvas.restoreToCount(saveCount);</span><br><span class="line">          onPostDraw();</span><br><span class="line">          swapBuffers(status);</span><br><span class="line">          attachInfo.mIgnoreDirtyState = false;</span><br><span class="line">        &#125;</span><br><span class="line">        -&gt; (Gl20Renderer 父类HardwareRenderer)#beginFrame() -&gt; nBeginFrame()</span><br><span class="line">          --JNI--&gt; android_view_HardwareRenderer_beginFrame() &#123;</span><br><span class="line">              EGLDisplay display = eglGetCurrentDisplay();</span><br><span class="line">              EGLSurface surface = eglGetCurrentSurface(EGL_DRAW);</span><br><span class="line">              eglBeginFrame(display, surface);</span><br><span class="line">            &#125;</span><br><span class="line">        -&gt; (Gl20Renderer 父类Glrenderer)#buildDisplayList(view, canvas) &#123; view.getDisplayList(); &#125;</span><br><span class="line">          -&gt; View#getDisplayList() -&gt; View#getDisplayList(mDisplayList, isLayer==false) &#123;</span><br><span class="line">              if displayList!=null: // 非第一次</span><br><span class="line">                dispatchGetDisplayList();</span><br><span class="line">                // DecorView 父类 ViewGroup#dispatchGetDisplayList &#123; for child: child.getDisplayList(); &#125;</span><br><span class="line">              else: // 第一次</span><br><span class="line">                !isLayer: mRecreateDisplayList = true;</span><br><span class="line">                displayList = (Gl20Renderer mAttachInfo.mHardwareRenderer).createDisplayList(name); // new GLES20DisplayList</span><br><span class="line">                invalidateParentCaches(); // mParent.mPrivateFlags |= PFLAG_INVALIDATED</span><br><span class="line">              HardwareCanvas canvas = displayList.start(width, height); // GLES20RecordingCanvas</span><br><span class="line">              layerType 初始化为 LAYER_TYPE_NONE:</span><br><span class="line">                computeScroll();</span><br><span class="line">                canvas.translate(-mScrollX, -mScrollY);</span><br><span class="line">                (View#)draw(canvas);</span><br><span class="line">              displayList.end();</span><br><span class="line">              displayList.setCaching(caching);</span><br><span class="line">              setDisplayListProperties(displayList);</span><br><span class="line">            &#125;</span><br><span class="line">            -&gt; GLES20DisplayList#start(width, height) &#123;</span><br><span class="line">                mCanvas = GLES20RecordingCanvas.obtain(this); // GLES20RecordingCanvas</span><br><span class="line">                mCanvas.start(); // &#123; mDisplayList.mBitmaps.clear(); mDisplayList.mChildDisplayLists.clear(); 都是ArrayList&#125;</span><br><span class="line">                mCanvas.setViewport(width, height);</span><br><span class="line">                mCanvas.onPreDraw(null); // --JNI--&gt; nPrepare() --C++--&gt; (OpenGlRenderer renderer)-&gt;prepareDirty()</span><br><span class="line">              &#125;</span><br><span class="line">              -&gt; GLES20RecordingCanvas#obtain(DisplayList) &#123;</span><br><span class="line">                  new GLES20RecordingCanvas();</span><br><span class="line">                  // 父类 GLES20Canvas(true, true) &#123; nCreateDisplayListRenderer(); // C++:new DisplayListRenderer &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            -&gt; (DecorView 父类View)#draw(canvas) &#123; // DecorView#draw() -&gt; FrameLayout#draw() -&gt; ViewGroup#draw()</span><br><span class="line">                // light version</span><br><span class="line">                onDraw(canvas);</span><br><span class="line">                dispatchDraw(canvas);</span><br><span class="line">                onDrawScrollBars(canvas);</span><br><span class="line">                // full version</span><br><span class="line">                canvas.saveLayer();</span><br><span class="line">                onDraw(canvas);</span><br><span class="line">                dispatchDraw(canvas);</span><br><span class="line">                canvas.drawRect();</span><br><span class="line">                onDrawScrollBars(canvas);</span><br><span class="line">              &#125;</span><br><span class="line">              -&gt; ViewGroup#dispatchDraw() &#123;</span><br><span class="line">                  for child: drawChild(canvas, child, drawingTime) -&gt; (View child).draw(canvas, this, drawingTime)</span><br><span class="line">                &#125;</span><br><span class="line">                -&gt; View#draw(canvas, parent==ViewGroup, drawingTime) &#123;</span><br><span class="line">                    useDisplayListProperties == true;</span><br><span class="line">                    hardwareAccelerated == true: // GLES20Canvas 父类HardwareCanvas 直接返回</span><br><span class="line">                      caching = true;</span><br><span class="line">                    layerType == LAYER_TYPE_NONE: 初始化值</span><br><span class="line">                      hasDisplayList = canHaveDisplayList(); // true</span><br><span class="line">                    useDisplayListProperties &amp;= hasDisplayList; // true</span><br><span class="line">                    useDisplayListProperties == true:</span><br><span class="line">                      displayList = getDisplayList(); // !!递归调自己</span><br><span class="line">                    hasNoCache == true:</span><br><span class="line">                      (HardwareCanvas 子类 GLES20RecordingCanvas canvas).drawDisplayList(displayList, null, flags);</span><br><span class="line">                  &#125;</span><br><span class="line">              -&gt; GLES20RecordingCanvas#drawRect() &#123;</span><br><span class="line">                super.drawRect(); </span><br><span class="line">                // (父类 GLES20Canvas)#drawRect() -&gt; nDrawRect() --JNI--&gt; (OpenGLRenderer renderer).drawRect()</span><br><span class="line">                recordShaderBitmap(paint); // mDisplayList.mBitmaps.add()</span><br><span class="line"></span><br><span class="line">            -&gt; GLES20DisplayList#end() &#123;</span><br><span class="line">                (GLES20RecordingCanvas mCanvas).onPostDraw();</span><br><span class="line">                mFinalizer == null:</span><br><span class="line">                  mFinalizer = new DisplayListFinalizer(mCanvas.end(0));</span><br><span class="line">                mCanvas.recycle();</span><br><span class="line">                mCanvas = null;</span><br><span class="line">                mValid = true;</span><br><span class="line">              &#125;</span><br><span class="line">              -&gt; GLES20RecordingCanvas#end(0) -&gt; (父类 GLES20Canvas)#getDisplayList(0)</span><br><span class="line">                --JNI--&gt; (DisplayListRenderer renderer).getDisplayList(DisplayList displayList==NULL) &#123;</span><br><span class="line">                  C++: return new DisplayList(*this); &#125;</span><br><span class="line">              -&gt; GLES20RecordingCanvas#recycle() &#123;</span><br><span class="line">                  mDisplayList = null;</span><br><span class="line">                  resetDisplayListRenderer(); // (父类 GLES20Canvas)#resetDisplayListRenderer() -&gt; nResetDisplayListRenderer</span><br><span class="line">                  sPool.release(this); // 放入缓存池, 方便下次重用</span><br><span class="line">                &#125;</span><br><span class="line">        -&gt; (Gl20Renderer 父类GlRenderer)#prepareFrame(dirty) -&gt; Gl20Renderer#onPreDraw(dirty)</span><br><span class="line">          -&gt; (GLES20Canvas mGlCanvas)#onPreDraw(dirty) --JNI--&gt; nPrepareDirty()</span><br><span class="line">            -&gt; (OpenGLRenderer renderer).prepareDirty() &#123;</span><br><span class="line">                setupFrameState();</span><br><span class="line">                if(mSnapshot-&gt;fbo == 0)</span><br><span class="line">                  syncState();</span><br><span class="line">                  updateLayers();</span><br><span class="line">                else</span><br><span class="line">                  startFrame();</span><br><span class="line">              &#125;</span><br><span class="line">              -&gt; OpenGlRenderer::setupFrameState() &#123;</span><br><span class="line">                  mCaches.clearGarbage();</span><br><span class="line">                  mSnapshot = new Snapshot();</span><br><span class="line">                  mSnapshot-&gt;fbo = getTargetFbo();</span><br><span class="line">                &#125;</span><br><span class="line">        -&gt; GLES20Canvas#drawDisplayList() --JNI--&gt; nDrawDisplayList()</span><br><span class="line">          --C++--&gt; (OpenGLRenderer renderer)::drawDisplayList() &#123;</span><br><span class="line">              if(CC_UNLIKELY(mCaches.drawDeferDisabled)):</span><br><span class="line">                status = startFrame();</span><br><span class="line">                displayList.replay(replayStruct, 0);</span><br><span class="line">                return status | replayStruct.mDrawGlStatus;</span><br><span class="line">              displayList.defer(deferStruct, 0);</span><br><span class="line">              flushLayers();</span><br><span class="line">              status = startFrame();</span><br><span class="line">              return status | deferredList.flush(*this, dirty);</span><br><span class="line">            &#125;</span><br><span class="line">        -&gt; (Gl20Renderer 父类Glrenderer)#swapBuffers(status) &#123;</span><br><span class="line">            if(status &amp; DisplayList.STATUS_DREW)</span><br><span class="line">              (EGL10 sEgl).eglSwapBuffers(sEglDisplay, mEglSurface);</span><br><span class="line">              checkEglErrors();</span><br><span class="line">          &#125;</span><br><span class="line">          -&gt; (EGL10 sEgl)#eglSwapBuffers() --JNI--&gt; jni_eglSwapBuffers() --C++--&gt; eglSwapBuffers(dpy, sur)</span><br></pre></td></tr></table></figure>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>


    
<nav id="article-nav">
    
        <a href="/nodejs/crypto模块使用/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">上一篇</strong>
            <div class="article-nav-title">
                
                    Node.js Crypto模块 使用示例
                
            </div>
        </a>
    
    
        <a href="/android/input-system/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">下一篇</strong>
            <div class="article-nav-title">Android 输入系统 源码分析</div>
        </a>
    
</nav>





    
    




<!-- baidu url auto push script -->
<script type="text/javascript">
    !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,o=document.referrer;if(!e.test(r)){var n="//api.share.baidu.com/s.gif";o?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var t=new Image;t.src=n}}(window);
</script>     
</section>
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            Wangmuy &copy; 2019 
            <a rel="external nofollow noopener noreferrer" href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png"></a>
            <br> Powered by <a href="http://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a>. Theme - <a href="https://github.com/zthxxx/hexo-theme-Wikitten" rel="external nofollow noopener noreferrer" target="_blank">wikitten</a>
            
                <br>
                <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i> <span id="busuanzi_value_site_pv"></span></span>
                &nbsp;|&nbsp;
                <span id="busuanzi_container_site_pv"><i class="fa fa-user"></i> <span id="busuanzi_value_site_uv"></span></span>
            
        </div>
    </div>
</footer>

        

    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    
        <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true,
            TeX: {
                equationNumbers: {
                  autoNumber: 'AMS'
                }
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
